<!doctype html>
<html>
<head>
	<link rel="stylesheet" type="text/css" href="__PUBLIC__/style/css/selectFilter.css">
	<link rel="stylesheet" type="text/css" href="__PUBLIC__/style/css/css.css">
    <include file="Public:common-head"/>
</head>
<body>
<include file="Public:common-toppart"/>
<!--<include file="Public:common-slider"/>-->

<form id="form2" name="form2" action="{:U('User/bindok')}" method="post">
<div class="house_banner">
	<div class="content">
		<p class="jiaofei_banner_01 font_yinying">房间绑定</p>
<p class="jiaofei_banner_03"></p>
<p class="jiaofei_banner_02 font_yinying">一户多房，轻松管理</p>

	</div>


</div>
    <div class="content_bg">
	<div class="content ">
	<p class="jiaofei_dqwz dqwz_bg">
        当前位置：<a href="http://www.66885890.com">首页</a> &nbsp;&nbsp;&gt;&nbsp;&nbsp;
            <a href="{:U('User/index',array('id'=>20))}">我的5890</a>&nbsp;&nbsp;&gt;&nbsp;&nbsp;
            <span class="green">房间绑定</span>
    </p>

		<div class="house_bdcgcontent clearfix">
        <p class="bangding_xian"></p>
        <p class="bangding_tips">
                      备注：带*号的为必填项，不带*号的为选填项，同一账号下最多能绑定三个房间
        </p>

        <div class="bangding_inputcontent">
        <div class="bangding_inputcontentone clearfix">
        <div class="history_inputboxone "><span>选择小区：</span>

		<div class="item_one item_two">	<!-- 这里开始 -->

				<select name="filter" id="village" class="item_two_select">
					<option value="" selected>请选择</option>
					<volist name="villagelist" id="item">
						<option value="{$item.COMMUNITYCODE}">{$item.COMMUNITYNAME}</option>
					</volist>

				</select><span style="position: absolute;left: 180px;top: 10px;color: #fd8320;">*</span>

			<!-- 这里结束 --></div>

		</div>

		<div class="history_inputboxone history_inputboxthree"><span>选择楼号：</span>
			<div class="item_one item_two">	<!-- 这里开始 -->

				<select name="filter" id="building" class="item_two_select">
					<option value="" selected>请选择</option>
				</select><span style="position: absolute;left: 180px;top: 10px;color: #fd8320;">*</span>

			</div>
		</div>

		<div class="history_inputboxone history_inputboxthree"><span>选择单元：</span>

			<div class="item_one item_two">	<!-- 这里开始 -->

				<select name="filter" id="uite" class="item_two_select">
					<option value="" selected>请选择</option>
				</select><span style="position: absolute;left: 180px;top: 10px;color: #fd8320;">*</span>

			<!-- 这里结束 --></div>

		</div>

	<div class="history_inputboxone history_inputboxthree"><span>选择门牌号：</span>

		<div class="item_one item_two">	<!-- 这里开始 -->

				<select name="filter" id="floor" class="item_two_select">
					<option value="" selected>请选择</option>
				</select><span style="position: absolute;left: 180px;top: 10px;color: #fd8320;">*</span>

			<!-- 这里结束 --></div>

		</div>

        </div>

        <div class="bangding_inputcontenttwo clearfix">
        	<div class="bangding_left">
        	<div style="padding-left: 0px;"><span class="name01" style="text-align: left;">业主姓名：</span><input type="text" id="ownername" name="ownername"/><span class="xing">*</span></div>
        	<div style="padding-left: 0px;"><span class="name01" style="text-align: left;">身份证号：</span><input type="text" id="papercode" name="papercode"/><span class="xing">*</span></div>
        	<div style="padding-left: 0px;"><span class="name01" style="text-align: left;">手机号码：</span><input type="text"  name="phone" id="phone"/><span class="xing">*</span></div>
        	<div class="bdfj_yzm"><span class="name01" style="text-align: left;">手机验证码：</span><input type="text"  id="phoneActive" name="phoneActiveCode"/><span class="xing">*</span><input type="button" id="getVerifyCodeBtn" value="获取验证码" onclick="buttonClick()" style="margin-left: 10px;display: inline-block;width: 130px;height: 42px;font-size: 15px;color: #333;
text-align: center;line-height: 42px;text-decoration: none;background:url(__PUBLIC__/style/img/bangding_bg.png) 0 0 no-repeat;"></div>

        	</div>
        	<div class="bangding_right" style="text-align: left">
        	<div class="clearfix">

        	<div>
        		<span class="name01">能源卡号：&nbsp;&nbsp;&nbsp;</span>
        		<!-- <input type="text" name="banknumber" id="banknumber"/> -->
        		<input style="width:45px;" type="text" name="yinhang1" id="yinhang1" value="" maxlength="4"><span class="hengxian">-</span>
				<input style="width:45px;" type="text" name="yinhang2" id="yinhang2" value="" maxlength="4"><span class="hengxian">-</span>
				<input style="width:45px;" type="text" name="yinhang3" id="yinhang3" value="" maxlength="4"><span class="hengxian">-</span>
				<input style="width:45px;" type="text" name="yinhang4" id="yinhang4" value="" maxlength="4">
        	</div>
        	<div>
        		<span class="name01">卡片期限：&nbsp;&nbsp;&nbsp;</span>
        		<!-- <input type="text" name="cardenddata" id="cardenddata" readonly/> -->
        		<select name="yue" id="yue" style="    height: 40px;
    line-height: 40px;
    margin:10px;
    width: 108px;
    border: 0;
    background-color: transparent;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding: 0;
    cursor: pointer;
    color: #666;
    font-size: 15px;
    background: #eff0f4;text-align:center;text-align-last:center;">
					<option value="" style="display: none"></option>
                    <option value="1">01</option>
                    <option value="2">02</option>
                    <option value="3">03</option>
                    <option value="4">04</option>
                    <option value="5">05</option>
                    <option value="6">06</option>
					<option value="7">07</option>
                    <option value="8">08</option>
                    <option value="9">09</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
					<option value="12">12</option>
                </select>月　
				 <select id="nian" name="nian" style="    height: 40px;
    line-height: 40px;
    margin:10px;
    width: 108px;
    border: 0;
    background-color: transparent;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding: 0;
    cursor: pointer;
    color: #666;
    font-size: 15px;
    background: #eff0f4;text-align:center;text-align-last:center;">
					<option value="" style="display: none"></option>
                    <option value="2016">2016</option>
                    <option value="2017">2017</option>
                    <option value="2018">2018</option>
                    <option value="2019">2019</option>
                    <option value="2020">2020</option>
                    <option value="2021">2021</option>
					<option value="2022">2022</option>
                    <option value="2023">2023</option>
                    <option value="2024">2024</option>
				</select>年　
        	</div>
        	<div class="bdfj_jfk"><span class="name01">环保积分卡：</span><input type="text" name="energycard" id="energycard" placeholder="垃圾大件预约业务需绑定环保计分卡"/> </div>
<div class="history_inputboxone clearfix" style="margin-left: 12px;"><span class=" ">住户人数：&nbsp;</span>

        <div class="item_one item_two"> <!-- 这里开始 -->
                    <div class="filter-box" id="ggg">
                <div class="filter-text">
                    <input class="filter-title " type="text" readonly="" placeholder="请选择">
                    <i class="icon icon-filter-arrow"></i>
                </div>
                <select name="houseHoldSize">
                    <option value="1">1</option>
                    <option value="2" >2</option>
                    <option value="3">3</option>
                    <option value="4" selected>4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                </select>
            </div>
            <!-- 这里结束 --></div>

        </div>

                <!--span class="xing zhrs">*</span-->
            </div>

        	</div>

        </div>

		<div class="jiebang">
			<a class="jiebang_btn01" onclick="checkFrom()"><span>确认绑定</span></a>
			<a class="jiebang_btn02" href="javascript:freset(document.form2)"><span>重置</span></a>
		</div>
		<input type="hidden" name="housecode" id="housecode">
        <input type="hidden" name="housename" id="housename">
        </div>

		</div>


	</div>
	</div>
</form>
<include file="Public:common-footer"/>
<include file="Public:common-script"/>
<script src="__PUBLIC__/style/laydate/laydate.js"></script>
<script type="text/javascript" src="__PUBLIC__/style/js/jquery.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/style/js/selectFilter.js"></script>
<script type="text/javascript" src="__PUBLIC__/js/artDialog4.1.7/artDialog.source.js?skin=green"></script>
<script type="text/javascript" src="__PUBLIC__/js/artDialog4.1.7/plugins/iframeTools.js"></script>
<script>
	lay('#version').html('-v'+ laydate.v);

	//执行一个laydate实例

	//年月选择器
	laydate.render({
	  elem: '#cardenddata'
	  ,type: 'month'
	});
</script>
<script type="text/javascript">

	$('#ggg').selectFilter({
		callBack : function (val){
			//返回选择的值
			console.log(val+'-是返回的值')
		}
	});

	function freset(obj){
		obj.reset();
	}

	//这里是初始化
	$('#village').on('change', function() {
            var val = this.value;
			$('#building').html('');
			$.ajax({
                url: '{:U("User/getBuilding","",false)}',
                type : 'POST',
                async: false,
                data : {parameter: val},
                dataType: 'json',
                success: function(ret){

					var optionStr = [];
					$.each(ret, function(i, item){
						if(i==0){optionStr.push('<option value="">' +"请选择"+ "</option>")};
						optionStr.push('<option value="'+ item.BUILDINGCODE +'">' +item.BUILDINGNAME+ "</option>");
						//optionStr.push('<li data-value="'+ item.BUILDINGCODE +'"><a title="'+ item.BUILDINGCODE +'">' +item.BUILDINGNAME+ "</a></li>");
					});
					$("#building").append(optionStr.join(''));
					//$('#building_1').html(optionStr_1.join(''));
                }
            });
	});

	$('#building').on('change', function() {
            var parameter = this.value;
            $('#uite').html('');
            $.ajax({
                url: '{:U("User/getUite","",false)}',
                type : 'POST',
                async: false,
                data : {parameter: parameter},
                dataType: 'json',
                success: function(ret){
					var optionStr = [];
					$.each(ret, function(i, item){
						if(i==0){optionStr.push('<option value="">' +"请选择"+ "</option>")};
						optionStr.push('<option value="'+ item.CELLCODE +'">' +item.CELLCODE+ "</option>");

					});
					$('#uite').html(optionStr.join(''));
                }
            });
        });

	$('#uite').on('change', function() {
            var parameter = this.value;
			var parameter1 = $('#building').val();
            $('#floor').html('');
            $.ajax({
                url: '{:U("User/getFloor","",false)}',
                type : 'POST',
                async: false,
                data : {parameter: parameter,parameter1: parameter1},
                dataType: 'json',
                success: function(ret){
					var optionStr = [];
					$.each(ret, function(i, item){
						if(i==0){optionStr.push('<option value="">' +"请选择"+ "</option>")};
						optionStr.push('<option value="'+ item.FLOORDOORPLATECODE +'">' +item.FLOORDOORPLATECODENUM+ "</option>");

					});
					$('#floor').html(optionStr.join(''));
                }
            });
        });

</script>
<script>
function checkFrom() {
		if ($("#village").val() == "" || $("#buliding").val() == "" || $("#uite").val() == "" || $("#floor").val() == "") {
			art.dialog({
				lock:true,
				content: '请选择完整的房间信息',
				time: 5
			});
			return false;
		}
		var ownername = $("#ownername").val();
		if (ownername == "") {
			art.dialog({
				lock:true,
				content: '业主姓名不能为空',
				time: 5
			});
			return false;
		}

		var papercode = $("#papercode").val();
		if (papercode == "") {
			art.dialog({
				lock:true,
				content: '身份证号不能为空',
				time: 5
			});
			return false;
		}
		var phone = $("#phone").val();
		if (phone == "") {
			art.dialog({
				lock:true,
				content: '手机号码不能为空',
				time: 5
			});
			return false;
		}

		if(!(/^(13|15|18|14|17|16|19)[0-9]{9}$/.test($("#phone").val()))){
		   art.dialog({
				lock:true,
				content: '请输入正确的手机号码',
				time: 5
			});
			$("#phone").focus();
			return false;
		}

		var phoneActive = $("#phoneActive").val();
		if (phoneActive == "") {
			art.dialog({
				lock:true,
				content: '手机验证码不能为空',
				time: 5
			});
			return false;
		}
		$.ajax({
			type: "POST",
			url: '{:U("User/check_phone_verify_code","",false)}',
			async:false,//设置同步/异步的参数[true异步  false同步]
			data: {phoneActiveCode:phoneActive},
			success: function(ret) {

				if(ret == 1){
					msg = "false";
					key = 1;
				}
				else if(ret == 2){
					msg = "false";
					key = 2;
				}
				else{
					msg = "success";
				}

			},
			dataType: 'json'
		});
		if(msg=="false"){
			if(key == 1){
				art.dialog({
					lock:true,
					content: '手机验证码错误，请核对！',
					time: 5
				});
				return false;
			}
			if(key == 2){
				art.dialog({
					lock:true,
					content: '手机验证码过期！',
					time: 5
				});
				return false;
			}
		}
		//var banknumber = $("#banknumber").val();

		var yinhang1 = $("#yinhang1").val();
        	if (yinhang1 != "" && yinhang1.length !=4) {
                art.dialog({
                  lock:true,
                  content: '请填入正确银行卡号,每空4位',
                  time: 5
                });
                return false;
              }
        	var yinhang2 = $("#yinhang2").val();
        	if (yinhang2 != "" && yinhang2.length !=4) {
                art.dialog({
                  lock:true,
                  content: '请填入正确银行卡号,每空4位',
                  time: 5
                });
                return false;
              }
        	var yinhang3 = $("#yinhang3").val();
        	if (yinhang3 != "" && yinhang3.length !=4) {
                art.dialog({
                  lock:true,
                  content: '请填入正确银行卡号,每空4位',
                  time: 5
                });
                return false;
              }
        	var yinhang4 = $("#yinhang4").val();
        	if (yinhang4 != "" && yinhang4.length !=4) {
                art.dialog({
                  lock:true,
                  content: '请填入正确银行卡号,每空4位',
                  time: 5
                });
                return false;
              }
		var banknumber = yinhang1+yinhang2+yinhang3+yinhang4;

              var yue = $("#yue").val();
			  
        	if (yue != "" && yue.length !=2) {
	                art.dialog({
	                  lock:true,
	                  content: '请填入正确月份,为2位，例：8月为08',
	                  time: 5
	                });
	                return false;
	              }
        	var nian = $("#nian").val();
        	if (nian != "" && nian.length !=2) {
	                art.dialog({
	                  lock:true,
	                  content: '请填入正确年份,为2位，例：2018年为18',
	                  time: 5
	                });
	                return false;
	              }
	        var cardenddata = nian+'-'+yue;

		//var cardenddata = $("#cardenddata").val();

		var energycard = $("#energycard").val();

		$("#housecode").attr("value",$('#building').val()+'-'+$('#uite').val()+'-'+$('#floor').val());
		$("#housename").attr("value",$('#village').find("option:selected").text()+$('#building').find("option:selected").text()+$('#uite').find("option:selected").text()+'单元'+$('#floor').find("option:selected").text());

		$.ajax({
			type: "POST",
			url: '{:U("User/check_ifbind","",false)}',
			async:false,//设置同步/异步的参数[true异步  false同步]
			data: {vHOUSECODE:$('#housecode').val()},
			success: function(ret) {
				if(ret == 0){
					msg = "false";
				}

				else{
					msg = "success";
				}

			},
			dataType: 'json'
		});
		if(msg=="false"){

			art.dialog({
				title: '提示', 
				lock:true,
				content: '此房间已被绑定，是否申请解绑该房间？',
				cancel:true,
				ok:function(){ 
					window.top.location="http://www.66885890.com/index.php?s=/user/qxbind";
					return false;
				} 
			});
			return false;

		}

		$.ajax({
			type: "POST",
			url: '{:U("User/check_phoneRight","",false)}',
			async:false,//设置同步/异步的参数[true异步  false同步]
			data: {vHOUSECODE:$('#housecode').val(),vOWNERNAME:ownername,vMOBILEPHONE:phone},
			success: function(res) {
				ret = res['CODE'];
				if(ret == 44){
					msg = "false";
					key = ret;
				}
				else{
					msg = "success";
				}

			},
			dataType: 'json'
		});
		if(msg=="false"){
			if(key == 44){
				art.dialog({
					lock:true,
					content: '房间信息的手机号不正确，请核对！',
					time: 5
				});
				return false;
			}
		}

		$.ajax({
			type: "POST",
			url: '{:U("User/check_houseinfo","",false)}',
			async:false,//设置同步/异步的参数[true异步  false同步]
			scriptCharset: 'GBK',
			data: {vHOUSECODE:$('#housecode').val(),vOWNERNAME:ownername,vPAPERCODE:papercode,vCARDENDDATE:cardenddata,vBANKNUMBER:banknumber},
			success: function(res) {
				ret = res['CODE'];
				if(ret == 40 || ret == 41 || ret == 42 || ret == 43){
					msg = "false";
					key = ret;
				}
				else{
					msg = "success";
				}

			},
			dataType: 'json'
		});
		if(msg=="false"){
			if(key == 40){
				art.dialog({
					lock:true,
					content: '业主姓名不正确，请核对！',
					time: 5
				});
				return false;
			}
			if(key == 41){
				art.dialog({
					lock:true,
					content: '身份证号不正确，请核对！',
					time: 5
				});
				return false;
			}
			if(key == 42){
				art.dialog({
					lock:true,
					content: '能源卡号到期时间不正确，请核对！',
					time: 5
				});
				return false;
			}
			if(key == 43){
				art.dialog({
					lock:true,
					content: '能源卡号不正确，请核对！',
					time: 5
				});
				return false;
			}
		}



    document.getElementById("form2").submit();
}
</script>
<script>
$('#getVerifyCodeBtn').on('click', function(){
	if ('' == $("#phone").val()) {
		 art.dialog({
			lock:true,
			content: '手机号码不能为空',
			time: 5
		});
		$("#phone").focus();
		return;
	}

	if(!(/^(13|15|18|14|17|16|19)[0-9]{9}$/.test($("#phone").val()))){
       art.dialog({
			lock:true,
			content: '请输入正确的手机号码',
			time: 5
		});
		$("#phone").focus();
		return false;
    }
	$("#getVerifyCodeBtn").attr('disabled',true);
	timerId = setInterval(refreshSecDisp, 1000);
	$.ajax({
		type: "POST",
		url: '{:U("Public/get_phone_verify_code","",false)}',
		data: {phone:$("#phone").val()},
		success: function( data ) {
			var retCode = data.code;
			if ('success' !== retCode) {
				$('#active_by_mail').attr('disabled', false);
				$('#active_by_phone').attr('disabled', false);
				$('#getVerifyCodeBtn').attr('disabled', false);
				$('#codeVerifyTip').text('获取手机验证码失败，请稍后再试。');
				return;
			}
		},
		dataType: 'json'
	});
});

var total_sec = 59;
var timerId;
function refreshSecDisp() {

	var btnDisp = '获取验证码';
	if (0 === total_sec) {
		removeTimer(timerId, 'getVerifyCodeBtn', btnDisp);
		timerId = null;
		total_sec = 59;
		return false;
	}

	btnDisp = btnDisp + '('+ total_sec +')';
	$('#getVerifyCodeBtn').val(btnDisp);
	total_sec = total_sec - 1;
}
function removeTimer(id, objId, objText) {
	if (null != id) {
		clearInterval(id);
	}
	$('#'+objId).val(objText);
	$('#'+objId).attr('disabled', false);
}
</script>
</body>
</html>