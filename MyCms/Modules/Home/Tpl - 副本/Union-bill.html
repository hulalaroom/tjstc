<include file="Public:header1" />
	
	<div class="gray"></div>
<div class="center_zfb"> 
 
 <div class="contentbox1">
 <div class="fptitle">电子发票详情</div>
 <div class="order_title" id="ddbh"></div>
 <div class="orderul">
 <ul class="clearfix">
 <li class="lione">发票类型</li>
 <li class="litwo">电子发票</li>
 </ul>
 <ul class="clearfix" style="display:none">
 <li class="lione">发票内容</li>
 <li class="litwo" id='fpnr'>个人明细</li>
 </ul>
 <ul class="clearfix">
 <li class="lione">发票抬头</li>
 <li class="litwo" id='fqtt'>个人</li>
 </ul>
 <ul class="clearfix">
 <li class="lione">发票状态</li>
 <li class="litwo" id='fqzt'></li>
 </ul>
 <ul class="clearfix" style='display:none' id='bz'>
	<li class="lione">未通过说明</li>
	<li class="litwo" id='bzsm'></li>
 </ul>
 
 
 </div>
 
  
 </div>
  <div class="contenttwo" style='display:none;font-size:15px;' id='fp'>
	  <ul class="clearfix ulborder">
	  <li>发票代码</li>
	  <li class="liborder">发票号码</li>
	  <li>下载</li>
	  </ul> 
	  <ul class="clearfix">
		  <li id='fpdm'></li>
		  <li id='fphm' class="liborder"></li>
		  <li><a id='fpxz' class="down">电子发票下载</a></li>
	  </ul> 
  </div>
 <div class="closebox" style='margin-top:10px'><a class="close">关闭</a></div>
   
</div>
<form name="form2" id="form2" action="" method="post">
<div class="jiaofei_banner">
	<div class="content">
		<p class="jiaofei_banner_01 font_yinying">在线缴费</p>
		<p class="jiaofei_banner_03 "></p>
		<p class="jiaofei_banner_02 font_yinying">续费随心，省事无忧</p>
	</div>
</div>
    <div class="content_bg">
	<div class="content history_content">
	<p class="jiaofei_dqwz history_dqwz">当前位置：<a href="/">首页</a> &nbsp;&nbsp;&gt;&nbsp;&nbsp;<a href="{:U('User/index')}">我的5890</a>&nbsp;&nbsp;&gt;&nbsp;&nbsp;<a href="{:U('Page/zsjf1','id=210')}">缴费业务</a>&nbsp;&nbsp;&gt;&nbsp;&nbsp;<span class="green">电子发票</span></p>	
<div class="history_bill">
	<div class="history_inputbox clearfix">
		<div class="history_inputboxone"><span>房间编号：</span>
		
		<div class="item_one">	<!-- 这里开始 -->		
					<div class="filter-box" id="aaa">
				<div class="filter-text">
					<input class="filter-title" type="text" readonly="" placeholder="请选择">
					<i class="icon icon-filter-arrow"></i>
				</div>
				<select name="houseCode">
					<volist name="houselist" id="hc">
					   <option value="{$hc.houseCode}" <if condition="$hc.houseCode eq $code">selected="selected"</if>>{$hc.address}</option>
					 </volist>
				</select>
			
		</div>
			</div>
			
		
		
		</div>	
		<div class="history_inputboxtwo"><span>交费日期：</span>
				<div class="item_one">	<!-- 这里开始 -->		
					<div class="filter-box">
				<div class="filter-text">
					<input class="filter-title"  name="kssj" type="text" id="kssj" size="10" maxlength="10" onclick="new Calendar().show(this);" readonly  value="{$kssj}">
				</div>
				
			</div>
			<!-- 这里结束 --></div>	
			-
				<div class="item_one">	<!-- 这里开始 -->		
					<div class="filter-box" id="ccc">
				<div class="filter-text">
					<input class="filter-title" type="text" name="jssj" id="jssj" onclick="new Calendar().show(this);" readonly size="10" maxlength="10" class="queryTime" value="{$jssj}">
					
				</div>
				
			</div>
			<!-- 这里结束 --></div>	
			
		</div>
		<button><span>查询</span></button>		
		
		</div>		
	</div>

<volist name="billlist" id="vo">
	<div class="dianzifapiao_table">

	<table width="100%" border="0" cellspacing="0" cellpadding="0">
	  <tbody>
		<volist name="vo['infor']" id="billinfor">
			<if condition="$key eq 1">
				<tr class="dianzifapiao_tr ">
				  <td colspan="8"><span class="dianzifapiao_sfq">收费日期：{$billinfor.operatedate|substr=0,10}&nbsp{$billinfor.operatedate|substr=11,8}</span><span class="dianzifapiao_ddh">订单号：{$billinfor.billcode}</span><span class="dianzifapiao_jftj">缴费途径：{$billinfor.jffs}</span></td>
				</tr>
			</if>
		</volist>
		<tr class="dianzifapiao_tr01">
		  <td width="12%">收费项目</td>
		  <td width="12%">收费期</td>
		  <td width="12%">单价(￥)</td>
		  <td width="12%">面积/用量</td>
		  <td width="12%">缴纳费用(￥)</td>
		  <td width="14%">费用状态</td>
		  <td width="14%">发票状态</td>
		  <td width="12%">操作</td>
		</tr>
		<volist name="vo['data']" id="bill">
			<tr class="dianzifapiao_tr02">
			  <td>
				<span>
					<if condition="($bill.itemcode eq B) OR ($bill.itemcode eq N) OR ($bill.itemcode eq M)"> <img src="__PUBLIC__/style/img/water.png" /></if>
					<if condition="($bill.itemcode eq D) OR ($bill.itemcode eq P) OR ($bill.itemcode eq Q)"> <img src="__PUBLIC__/style/img/tianranqi.png" /></if>
					<if condition="($bill.itemcode eq A)"> <img src="__PUBLIC__/style/img/gongnuan.png" /></if>
				</span>
				{$bill.itemname}
			  </td>
			  <td>{$bill.chargemonth}</td>
			  <td>{$bill.price}</td>
			  <td>{$bill.chargearea}</td>
			  <if condition="$key eq 0">
				  <td rowspan="{$vo['infor'] | count}">{$bill.sshj}</td>
				  <td rowspan="{$vo['infor'] | count}" class="dianzifapiao_td01" ><span><img src="__PUBLIC__/style/img/duihao.png" /></span>已缴成功</td>
				  <td rowspan="{$vo['infor'] | count}" class="dianzifapiao_td02">{$bill.invstatus}</td>
				  <td rowspan="{$vo['infor'] | count}">
				  <if condition="$bill.invstatus eq '未申请'">
					<a class="btn02" onclick="apply('{$bill.billcode}','{$bill.invstatus}')"><span>申请</span></a>
					<else />
						<a class="btn01"><span>申请</span></a>
					</if>
					<if condition="$bill.invstatus eq '可下载'">
						<a class="btn02" onclick="downloadFp('{$bill.invurl}','{$bill.invstatus}')"><span>下载</span>
					<else />
						<a class="btn01"><span>下载</span></a>
					</if>
					<a class="btn03" onclick="getDetail('{$bill.billcode}','{$bill.invurl}','{$bill.invoicecode}','{$bill.invoicenumber}','{$bill.examineopinion}','{$bill.invstatus}','{$bill.owner}')"><span>详情</span></a>
					
				  </td>
			  </if>
			</tr>
			
		</volist>
	  </tbody>
	</table>
	</div>
</volist>
<input type='hidden' name='page' id='page' value="{$page}">
    <div class="page">
		{$fy}
	</div>
</form>
<!--<div class="page">
<a href=""><span><img src="img/page_left.png" alt="" /></span> </a>
<a href=""><span class="page_num">1</span> </a>
<a href=""><span><img src="img/page_right.png" alt="" /></span> </a>
<input type="text" name="" id="" value="20条/页" />跳至
<input type="text" name="" id="" value="" />页
</div>-->
<div class="dianzifapiao_warm">
<p class="warm">温馨提示：<br>
	发票状态：选择房间地址和交费日期，点击查询后，下面列表显示的“发票状态”列有四种状态<br>
	1、未申请：说明此条缴费记录没有开具过电子发票，同时具备开具电子发票的条件，点击申请按钮可以申请开具电子发票。<br>
	2、可下载：说明此条缴费记录已开具电子发票，点击下载按钮可下载此条缴费记录对应PDF格式的电子发票文件。<br>
	3、审核中：说明此条缴费记录已进行了开具操作，正在由能源公司审批中，还未通过。<br>
	4、开具失效：说明此条缴费记录已开具了纸质发票或者是2018年1月1日之前的缴费记录，不具备开具电子发票的条件。<br>
	<span class="promptColor_red">单次缴纳多种能源费用问题：</span><br>
	在能源公司缴费大厅缴费时，单次缴纳了多个月份和多个收费项目的费用，并且只打印了收据没有开具纸质发票，在开具电子发票时会同时将当时单次缴纳的所有缴费记录开具在一张电子发票上。<br>
	例：在缴费大厅缴费时，同时缴纳了201801、201802月份的自来水费，及201801、201802的天然气费，在开具电子发票时会同时将这四笔缴费记录开具在一张电子发票上。<br>
	<span class="promptColor_red">注意：只有2018年1月1日之后缴纳的费用才可以申请电子发票。</span>
</p>
</div>

	</div>	
	</div>

<include file="Public:footer1" />
</body>
</html>
<script src="__PUBLIC__/js/jquery.KinSlideshow-1.2.1.min.js" type="text/javascript"></script>
<script src="__PUBLIC__/js/jquery.textSearch-1.0.js" type="text/javascript"></script>
<script type="text/javascript" src="__PUBLIC__/js/Calendar.js"></script>
<script src="__PUBLIC__/js/script.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src="__PUBLIC__/style/js/jquery.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/style/js/selectFilter.js"></script>
<script type="text/javascript">
	//本小插件支持移动端哦
	
	//这里是初始化
	$('#aaa').selectFilter({
		callBack : function (val){
			//返回选择的值
			console.log(val+'-是返回的值')
		}
	});
	
</script> 

<script type="text/javascript">
	function getDetail(billcode,invurl,invoicecode,invoicenumber,examineopinion,invstatus,owner){
		$("#ddbh").html('订单编号：'+billcode);
		$("#fqzt").html(invstatus);
		$("#fqtt").html(owner);
		if(invstatus == '审核未通过'){
			$("#bzsm").html(examineopinion);
			$("#bz").show();
		}
		else{
			$("#bz").hide();
		}
		if(invstatus == '可下载'){
			if(invoicenumber == '' || invoicecode == '' || invurl == ''){
				$("#fp").hide();
			}
			else{
				$("#fpdm").html(invoicenumber);
				$("#fphm").html(invoicecode);
				$('#fpxz').attr('href',invurl);
				$("#fp").show();
			}
			
		}
		else{
			$("#fp").hide();
		}

		$(".gray").show();
		$(".center_zfb").show();
	}

	function downloadFp(invurl,invstatus){
		
		if(invstatus != '可下载'){
			alert('发票状态为：'+invstatus+'，无法下载！');
			return false;
		}
		else{
			if(invurl == ''){
				alert('下载异常，请稍候再试！');
				return false;
			}
			//location.href = 'http://www.66885890.com/Public/images/123.rar';
			downloadFile(invurl);
		}
		
	}

	function downloadFile(url) {   
	   try{ 
			var elemIF = document.createElement("iframe");   
			elemIF.src = url;   
			elemIF.style.display = "none";   
			document.body.appendChild(elemIF);   
		}catch(e){ 
			zzrw.alert("下载异常！");
		}     
	}

	function apply(billcode,invstatus){
		
		if(invstatus == '未申请' || invstatus == '审核未通过'){
			$.ajax({
				url: '{:U("/Union/applyInvioce")}',
				type: 'POST',
				data: {billcode:billcode,invstatus:invstatus},
				dataType: 'json',
				success: function(res) {
					if(res["r_code"] == '0000'){
						alert("申请成功，请耐心等待审核！");
					}
					else{
						alert(res["r_meaning"]+'!');
					}
					//location.reload();
					document.getElementById("form2").submit();
				}
			});
		}
		else{
			alert('发票状态为：'+invstatus+'，无法申请！');
			return false;
		}
		
	}
$(document).ready(function(){
  
  $(".close").click(function(){
  $(".gray").hide();
  $(".center_zfb").hide();
  });
  
});
</script>	 

<script type="text/javascript">
	
	function checkForm(){
		var kssj = $("#kssj").val();
		var jssj = $("#jssj").val();
		document.getElementById('page').value = '';

		if(kssj == '' || jssj == ''){
			art.dialog({content:'交费日期不能为空',time:10});
			return false;
		}

		var s1 = '2018-01-01';
		s1 = new Date(s1.replace(/-/g, "/"));
		s2 = new Date(kssj.replace(/-/g, "/"));
		s3 = new Date(jssj.replace(/-/g, "/"));
		var days = s2.getTime() - s1.getTime();
		var time = parseInt(days / (1000 * 60 * 60 * 24));

		var days1 = s3.getTime() - s1.getTime();
		var time1 = parseInt(days1 / (1000 * 60 * 60 * 24));

		if(time < 0 || time1 < 0){
			art.dialog({content:'2018年1月1日之后的订单才可申请发票，请选择正确的交费日期',time:10});
			return false;
		}
		
		return true;
	}


	function getPage(p){
		document.getElementById('page').value = p;
		document.getElementById("form2").submit();
	}
</script>
